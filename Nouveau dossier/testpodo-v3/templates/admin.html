<!doctype html>
<html lang="fr"><head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/static/style.css">
  <title>Admin â€“ PodoTest</title>
</head>
<body class="page">
  <div class="admin-wrap">

    <div class="admin-header animate-in">
      <div>
        <div class="eyebrow">ğŸ” Administration</div>
        <h1 style="font-size:2rem;margin:6px 0 4px">Tableau de bord</h1>
        <p class="muted small">PodoTest Â· RÃ©sultats des candidats</p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <a class="btn btn-primary" href="/admin/export.csv">â¬‡ Exporter CSV</a>
        <a class="btn btn-secondary" href="/admin/logout">DÃ©connexion</a>
        <a class="btn btn-secondary" href="/">â† Accueil</a>
      </div>
    </div>

    {% if sessions_data %}
      {% set nb = sessions_data | length %}
      {% set scores_list = sessions_data | map(attribute='score_pct') | list %}
      {% set avg = (scores_list | sum / nb) | round | int if nb > 0 else 0 %}
      {% set high = sessions_data | selectattr('score_pct','ge',80) | list | length %}

      <div class="stats-grid animate-in" style="animation-delay:.08s">
        <div class="stat-card stat-teal">
          <div class="stat-num">{{ nb }}</div>
          <div class="stat-lbl">Sessions totales</div>
        </div>
        <div class="stat-card stat-blue">
          <div class="stat-num">{{ sessions_data | selectattr('session.prenom') | list | length }}</div>
          <div class="stat-lbl">Profils remplis</div>
        </div>
        <div class="stat-card stat-coral">
          <div class="stat-num">{{ avg }}%</div>
          <div class="stat-lbl">Score moyen</div>
        </div>
        <div class="stat-card stat-green">
          <div class="stat-num">{{ high }}</div>
          <div class="stat-lbl">Score â‰¥ 80%</div>
        </div>
      </div>
    {% endif %}

    <div class="table-card animate-in" style="animation-delay:.12s">
      {% if sessions_data %}
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Candidat</th>
            <th>RÃ´le</th>
            <th>ExpÃ©rience</th>
            <th>Magasin</th>
            <th>Score</th>
            <th>RÃ©sultat</th>
          </tr>
        </thead>
        <tbody>
          {% for row in sessions_data %}
          {% set s = row.session %}
          <tr>
            <td style="white-space:nowrap;color:var(--text2);font-size:.82rem">
              {{ s.created_at.strftime('%d/%m/%Y') if s.created_at else 'â€”' }}<br>
              <span style="font-size:.75rem">{{ s.created_at.strftime('%H:%M') if s.created_at else '' }}</span>
            </td>
            <td class="candidate-name">
              {% if s.prenom or s.nom %}
                <strong>{{ s.prenom }} {{ s.nom }}</strong>
              {% else %}
                <span style="color:#9ca3af;font-style:italic">Non renseignÃ©</span>
              {% endif %}
            </td>
            <td>
              {% if s.role %}
                <span class="tag tag-teal">{{ s.role | replace('_',' ') | title }}</span>
              {% else %}â€”{% endif %}
            </td>
            <td style="font-size:.85rem;color:var(--text2)">
              {{ s.experience | replace('_',' ') if s.experience else 'â€”' }}
            </td>
            <td style="font-size:.85rem;color:var(--text2)">
              {{ s.shop_type | replace('_',' ') | title if s.shop_type else 'â€”' }}
            </td>
            <td style="font-weight:600;font-family:'Syne',sans-serif">
              {{ row.correct }} / {{ row.total }}
            </td>
            <td>
              {% if row.score_pct >= 80 %}
                <span class="score-pill score-high">ğŸ† {{ row.score_pct }}%</span>
              {% elif row.score_pct >= 60 %}
                <span class="score-pill score-mid">ğŸ‘ {{ row.score_pct }}%</span>
              {% else %}
                <span class="score-pill score-low">ğŸ“š {{ row.score_pct }}%</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="empty-state">
          <p style="font-size:2.5rem">ğŸ“‹</p>
          <p style="font-weight:600;margin:8px 0 4px">Aucune session enregistrÃ©e</p>
          <p class="muted small">Les rÃ©sultats apparaÃ®tront ici aprÃ¨s le premier quiz.</p>
          <a class="btn btn-primary" href="/" style="margin-top:16px">Lancer un quiz</a>
        </div>
      {% endif %}
    </div>

  </div>
</body></html>
